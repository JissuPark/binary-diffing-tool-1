{% extends "Main_engine/layout.html" %}

{% block title %} 결과 페이지 {% endblock %}

{% block head %}
    {% load static %} <!-- static files are loaded -->



    <style>
        button#select-oper {
            background-color: lightgray;
            border-radius: 5px;
            font-weight: bold;
            font-size: large;
            width: 20%;
            margin-left: 20px;
            margin-right: 20px;
            text-align: center;
        }

        button#select-oper:hover {
            background-color: #d8d8d8;
            color: red;
            border: white;
        }

        p.file_text {
            width: 20%;
            margin: 6px;
            font-size: large;
            font-weight: bold;
            text-align: center;
        }
    </style>
{% endblock head %}

{% block section %}

    {% load static %}
    <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom mt-5">
        <h3>Result</h3>
        <div class="btn-toolbar mb-2 mb-md-0">
            <div class="btn-group mr-2">
                <button type="button" class="btn btn-sm btn-outline-secondary">high</button>
                <button type="button" class="btn btn-sm btn-outline-secondary">all</button>
            </div>
        </div>
    </div>

    {#휴리스틱 스코어부분 #}
    <!--원래 있던 차트 부분-->
    <br>
<!------------------------ select file, target file 부분-------------------------------->
    <div style="display:inline-flex; width:100%;">
        <p class="file_text">select base file : </p>
        <select id="select_base" class="selectpicker" data-live-search="true" data-width="20%" data-size="5"
                title="Choose base"></select>


        <p class="file_text">select target file : </p>
        <select id="select_target" class="selectpicker" data-width="20%" data-size="5" multiple
                title="Choose targets"></select>


        <button id="select-oper">select</button>
    </div>
    <!------------------------ select file, target file 부분-------------------------------->

    <hr class="my-hr3"><h5 id="heuristic" class="mt-2 mb-3" style="font-weight: bold;">Heuristic Score</h5>
    <hr class="my-hr3">

    <!--원래 있던 차트 부분-->
 <div id="test" class="card-deck ml-2 mr-2 mt-2">

    </div>

    <hr class="my-hr3"><h5 id="scoretable" class="mt-2 mb-3" style="font-weight: bold;">Detail</h5>
    <hr class="my-hr3">

    <div class="container-fluid col-12">
        <div class="card pl-4 pr-4">
            <div class="table-responsive ">
                {% csrf_token %}
                {% if result %}
                    <div id="result_json">
                        <table id="result_table" class="table table-borderless" style="text-align: center;">
                            <thead>
                            <tr>
                                <th rowspan="2" align=center>File Name</th>
                                <!--                <th rowspan="2">Timestamp</th>-->
                                <th colspan="2">Algorithm</th>
                                <th colspan="6">PE META data</th>
                            </tr>
                            <tr>
                                <th>BBH</th>
                                <th>Constant</th>
                                <th>Section data</th>
                                <th>certification</th>
                                <th>PDB</th>
                                <th>imp-hash</th>
                                <th>Rich-xorkey</th>
                            </tr>
                            </thead>
                        </table>
                    </div>
                    </div>
                    </div>
                    </div>
                <script>
                    /* 엔진에서 받아온 값 */
                        var result = "{{result}}";
                        /* JSON.parse()에서 따옴표, nan 기타 등등 있으면 오류남 */
                        var text_res = result.replace(/&#39;/gi, '"').replace(/\t/gi, "\\t").replace(/\r/gi, "\\r").replace(/\n/gi, "\\n").replace(/nan/gi, '"nan"');
                        /* 결과값 파싱해서 테이블 추가하는 부분 */
                        /* 테이블 불러오기 */
                        var res_table = document.getElementById("result_table");
                        /* 결과 데이터 파싱 */

                        var json_res = JSON.parse(text_res);
                        /* 파일에 맞게 동적으로 dropdown에 option 추가해주는 부분 */
                        var pickerclass = document.getElementsByClassName("selectpicker");
                        for (var picker = 0; picker < pickerclass.length; picker++) {
                            for (var standard in json_res) {
                                var option = document.createElement("option");
                                option.value = standard;
                                option.text = standard;
                                pickerclass.item(picker).appendChild(option);

                            }
                        }
                        /* 버튼 클릭하면 데이터 변하게 하는 함수 */
                        $("#select-oper").click(function () {
                            $all_select();
                        });

                        /* 기준이 바뀌면 대상에 disable 거는 함수 */
                        $("#select_base").on("changed.bs.select", function () {
                            var selected = $("#select_base").children("option:selected").text();        // 기준 파일명을 가져옴
                            $("#select_target option").prop('disabled', false);                         // 전체 초기화
                            $('#select_target').find('[value="' + selected + '"]').prop('selected', false);// 체크도 해제
                            $("#select_target").find('[value="' + selected + '"]').prop('disabled', true);// 기준과 같은 옵션 disable
                            $("#select_target").selectpicker('refresh');                                // 새로고침
                        });

                        var i = 0;
                        var array = [" pink", "", " yellow-b"];
                        var b_array = [" pink", " green", " yellow-b"];
                        var bar_title = ["BASICBLOCK:", "CONSTANT:", "PE:"];



                    /* 기준이 변하면 테이블이 변경될 수 있도록 */
                    $all_select = function () {
                        var targets = $('#select_target').val();
                        $("test").empty();
                        /* 기준이 변할때마다 테이블을 지우고 새로 시작 */
                        for (var row = res_table.rows.length - 1; row > 1; row--) {
                            res_table.deleteRow(row);
                        }

                        for (var standard in json_res) {
                            var sel = document.getElementById("select_file");
                            var selected = $("#select_base").children("option:selected").text();
                            if (standard == selected) {
                                // document.write(sel.selectedIndex + " is " + "<br>");
                                var index = 0;
                                /* 대상이 변할때마다 */
                                for (var target in json_res[standard]) {
                                    for (var t in targets) {
                                        // 선택된 대상에 대해서만 보여줌
                                        if (target == targets[t]) {

                                            var basic_block = json_res[standard][target][2] * 100;
                                            var constant = json_res[standard][target][3] * 100;
                                            height = [basic_block + "%", constant + "%", "50%"];

// Create the chart
                                            var col = document.createElement("div");
                                            col.id = "col" + i;
                                            col.className = " col-xl-2 col-lo-3 col-12 ";
                                            document.getElementById("test").appendChild(col);

                                            var card = document.createElement("div");
                                            card.id = "card" + i;
                                            card.className = "card";
                                            document.getElementById("col" + i).appendChild(card);

                                            var panel = document.createElement("section");
                                            panel.id = "panel" + i;
                                            panel.className = "panel";
                                            document.getElementById("card" + i).appendChild(panel);

                                            var panel_body = document.createElement("div");
                                            panel_body.id = "panel_body" + i;
                                            panel_body.className = "panel-body";
                                            document.getElementById("panel" + i).appendChild(panel_body);

                                            var top_stats_panel = document.createElement("div");
                                            top_stats_panel.id = "top_stats_panel" + i;
                                            top_stats_panel.className = "top-stats-panel";
                                            document.getElementById("panel_body" + i).appendChild(top_stats_panel);

                                            var h4 = document.createElement("h4");
                                            h4.id = "widget-h";
                                            h4.className = "widget-h";
                                            h4.textContent = "file_name:";
                                            document.getElementById("top_stats_panel" + i).appendChild(h4);

                                            var bar_stats = document.createElement("div");
                                            bar_stats.id = "bar_stats" + i;
                                            bar_stats.className = "bar-stats";
                                            document.getElementById("top_stats_panel" + i).appendChild(bar_stats);

                                            var progress_stat_bar = document.createElement("ul");
                                            progress_stat_bar.id = "progress_stat_bar" + i;
                                            progress_stat_bar.className = "progress-stat-bar clearfix";
                                            document.getElementById("bar_stats" + i).appendChild(progress_stat_bar);

                                            //막대 바 부분
                                            for (var a = i * 3; a <= (i * 3) + 2; a++) {
                                                var percent = document.createElement("li");
                                                percent.id = "percent" + a;
                                                percent.setAttribute("data-percent", "50%");
                                                document.getElementById("progress_stat_bar" + i).appendChild(percent);

                                                var percent_span = document.createElement("span");
                                                percent_span.id = "percent_span" + a;
                                                percent_span.className = "progress-stat-percent" + array[(a % 3)];
                                                percent_span.style = "height: " + height[(a % 3)];
                                                percent_span.setAttribute("data-toggle", "tooltip");
                                                percent_span.setAttribute("data-placement", "left");
                                                percent_span.setAttribute("title", height[(a % 3)]);
                                                document.getElementById("percent" + a).appendChild(percent_span);
                                            }


                                            var bar_legend = document.createElement("ul");
                                            bar_legend.id = "bar_legend" + i;
                                            bar_legend.className = "bar-legend";
                                            document.getElementById("bar_stats" + i).appendChild(bar_legend);

                                            // //표시부분
                                            for (var b = i * 3; b <= (i * 3) + 2; b++) {
                                                //li생성
                                                var legend_pointer = document.createElement("li");
                                                legend_pointer.id = "legend_pointer" + b;
                                                document.getElementById("bar_legend" + i).appendChild(legend_pointer);

                                                //span 생성
                                                var legend_span = document.createElement("span");
                                                legend_span.id = "legend_span";
                                                legend_span.className = "bar-legend-pointer" + b_array[(b % 3)];
                                                document.getElementById("legend_pointer" + b).appendChild(legend_span);

                                                var test = document.createTextNode(bar_title[(b % 3)] + " " + height[(b % 3)]); //베이직블록 유사도 : pe 유사도, 상수 유사도 -> string fix, values 동적 할당
                                                document.getElementById("legend_pointer" + b).appendChild(test);
                                            }

                                        }
                                        i++;
                                    }
                                    i = 0;
                                    $(function () {
                                        $('[data-toggle="tooltip"]').tooltip()
                                    });
                                }
                            }

                        }
                        ;
                        // 페이지가 처음 뜰 때 기준은 처음으로 대상은 전부 선택해서 보여주도록
                        var first_base = $("#select_base").find('option:first');
                        first_base.attr('selected', 'selected');
                        $('#select_target option').prop('selected', true);
                        $('#select_target').find('[value=' + first_base.text() + ']').prop('selected', false);
                        $('#select_target').find('[value=' + first_base.text() + ']').prop('disabled', true);

                        $all_select();
                    };

                </script>

                </div>
            {% else %}
                <h1>There is not result!</h1>
            {% endif %}
    </div>

{% endblock section %}