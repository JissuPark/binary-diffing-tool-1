{% extends "Main_engine/layout.html" %}

{% block title %} 결과 페이지 {% endblock %}


{% block head %}
{% load static %} <!-- static files are loaded -->
<link href="{% static 'Main_engine/css/style.css' %}" rel="stylesheet" media="screen">
<link href="{% static 'Main_engine/css/fakeLoaer.css' %}">
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.7.2/jquery.min.js"></script>
<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.11.1/jquery.min.js"></script>
<script src="https://code.highcharts.com/highcharts.js"></script>
<script src="{% static 'Main_engine/js/jquery.timelinr-0.9.7.js' %}"></script>
<script src="{% static 'Main_engine/css/hightchart.css' %}"></script>

<script>
    $(function () {
        $().timelinr({
            arrowKeys: 'true'
        })
    });

</script>

{% endblock head %}

{% block section %}

{% load static %}


<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom mt-5">
    <h3>Result</h3>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group mr-2">
            <button type="button" class="btn btn-sm btn-outline-secondary">high</button>
            <button type="button" class="btn btn-sm btn-outline-secondary">all</button>
        </div>
        <!--<button type="button" class="btn btn-sm btn-outline-secondary dropdown-toggle">
          <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="feather feather-calendar"><rect x="3" y="4" width="18" height="18" rx="2" ry="2"></rect><line x1="16" y1="2" x2="16" y2="6"></line><line x1="8" y1="2" x2="8" y2="6"></line><line x1="3" y1="10" x2="21" y2="10"></line></svg>
          This week
        </button>-->
    </div>
</div>

<h5 id="timeline2">Time Line</h5>
<div id="tileline_frame">
  <div id="timeline">
    <ul id="dates">
    {% for pe in pe_%}
    <li><a href=#{{pe.year}} style="color: #ffcc00;">{{pe.year}}</a></li>
    {%endfor%}
    </ul>
    <ul id="issues">
    {% for pe in pe_%}
    <li id={{pe.timestamp}}>
      <img src="{% static 'Main_engine/images/test1.png' %}" width="256" height="256" />
      <h1>{{pe.timestamp}}</h1>
<!--      <p> File Name : {{pe.filename}}</p>-->
      <p> File Size : {{pe.filesize}}</p>
      <p> File Type : {{pe.filetype}}</p>
<!--      <p> File Sha-256 :{{pe.sha_256}}</p>-->
      <p> TimeStamp : {{pe.timestamp}}</p>
    </li>
    {%endfor%}
    </ul>

  <div id="grad_left"></div>
  <div id="grad_right"></div>
  <a href="#" id="next">+</a>
  <a href="#" id="prev">-</a>
  </div>
</div>
{#휴리스틱 스코어부분 #}
<!--원래 있던 차트 부분-->
<br>

<hr class="my-hr3"><h5 id="heuristic" class="mt-2 mb-3" style="font-weight: bold;">Heuristic Score</h5><hr class="my-hr3">
<!--원래 있던 차트 부분-->


     <div class="card-deck ml-3 mr-3 mt-4">
      <div class="card">
            <div id="mychart0"></div>
        <div class="card-body">
         <h5 class="card-title">Target File</h5>
         <p class="card-text">대상파일 : 630d925fd51964cae86892647069f3555874f48cba2f7be0920c9293b376f0af</p>
        </div>
      </div>
      <div class="card">
          <div id="mychart1"></div>
        <div class="card-body">
         <h5 class="card-title">Target File</h5>
         <p class="card-text">대상파일 : 7b6c34896babba1bee97387a862dfd60d243d711000f3837dcbf3dd7b0e838a4</p>
        </div>
      </div>
      <div class="card">
            <div id="mychart2"></div>
        <div class="card-body">
         <h5 class="card-title">Target File</h5>
         <p class="card-text">대상파일 : cec477937ea389408749cf7969f27e3dbd1136d888b3c99f8c5c5f843a40b731</p>
        </div>
      </div>
      <div class="card">
           <div id="mychart3"></div>
         <div class="card-body">
         <h5 class="card-title">Target File</h5>
         <p class="card-text">대상파일 : d3ee9cf0ad24519e40f3788fdc453074344c82effebb7c0ea1c4343b4f4dc9d9</p>
         </div>
        </div>
     </div>
<br>
<br>

<hr class="my-hr3"><h5 id="scoretable" class="mt-2 mb-3" style="font-weight: bold;">Detail</h5><hr class="my-hr3">
<div class="container-fluid">
<div class="table-responsive container-fluid">
    {% csrf_token %}
    {% if result %}
    <div id="result_json">
        <form name="select_form">
            <select id="select_file" onchange="change_table()"></select>
        </form>
        <br>
        <table id="result_table" class="table table-corderless" style="text-align: center;">
            <thead>
            <tr>
                <th rowspan="2" align=center>File Name</th>
<!--                <th rowspan="2">Timestamp</th>-->
                <th colspan="2">Algorithm</th>
                <th colspan="6">PE META data</th>
            </tr>
            <tr>
                <th>BBH</th>
                <th>Constant</th>
                <th>Section data</th>
                <th>certification</th>
                <th>PDB</th>
                <th>imp-hash</th>
                <th>Rich-xorkey</th>
            </tr>
            </thead>
        </table>
    </div>
    </div>
        </div>
        <script>
            var dictionary = "{{ json_data }}";
            {#document.write(dictionary);#}
            /* 엔진에서 받아온 값 */
            var result = "{{result}}";
            /* JSON.parse()에서 따옴표 있으면 오류남 */
            var text_res = result.replace(/&#39;/gi, '"');
            /* 결과값 파싱해서 테이블 추가하는 부분 */
            /* 테이블 불러오기 */
            var res_table = document.getElementById("result_table");
            /* 결과 데이터 파싱 */
            var json_res = JSON.parse(text_res);
            /* 기준 파일을 선택할 select 태그 생성
            var select_file = document.createElement("SELECT");
            select_file.id = "standard_file";
            document.select_form.appendChild(select_file);
            */
            var select_file = document.getElementById("select_file");
            for (var standard in json_res) {
                var option = document.createElement("option");
                option.value = standard;
                option.text = standard;
                select_file.appendChild(option);
            }
            select_file.selectedIndex = 0;
            /* 기준이 변하면 테이블이 변경될 수 있도록 */
            function change_table() {
                /* 기준이 변할때마다 테이블을 지우고 새로 시작 */
                for (var row = res_table.rows.length - 1; row > 1; row--) {
                    res_table.deleteRow(row);
                }
                for (var standard in json_res) {
                    /*document.write("standard is " + standard +"<br>");*/
                    var sel = document.getElementById("select_file");
                    if (standard == sel.options[sel.selectedIndex].value) {
                        /* 대상이 변할때마다 */
                        for (var target in json_res[standard]) {
                            /*document.write("target is " + target + "<br>");*/
                            /*document.write(json_res[standard][target]+ "<br>");*/
                            /* 하단에 행 추가 */
                            var new_row = res_table.insertRow(res_table.rows.length);
                            /* 행에 열 추가 */
                            var filename = new_row.insertCell(0);
                            var bbh = new_row.insertCell(1);
                            var constvalue = new_row.insertCell(2);
                            var section = new_row.insertCell(3);
                            var cert = new_row.insertCell(4);
                            var pdb = new_row.insertCell(5);
                            var imph = new_row.insertCell(6);
                            var xor = new_row.insertCell(7);
                            /* 열에 데이터 입력 */
                            filename.innerHTML = json_res[standard][target][0];
                            bbh.innerHTML = json_res[standard][target][2];
                            constvalue.innerHTML = json_res[standard][target][3];
                            section.innerHTML = json_res[standard][target][4];
                            cert.innerHTML = json_res[standard][target][5];
                            pdb.innerHTML = json_res[standard][target][6];
                            imph.innerHTML = json_res[standard][target][7];
                            xor.innerHTML = json_res[standard][target][8];
                            /*
                            출력해서 맞는지 확인
                            for(var data in json_res[standard][target]){
                                document.write("data is "+ data +" "+ json_res[standard][target][data] + "<br>");
                                console.log(typeof json_res[standard][target][data])
                            }
                            */
                        }
                    }
                }
            }
            change_table();

var i=0;
for(var key in json_res){
    for(var vkey in json_res[key]){
        var name = json_res[key][vkey][0];
        var a = json_res[key][vkey][2];
        var b = json_res[key][vkey][3];
        var id_str = "mychart" + i;
// Create the chart
Highcharts.chart(id_str, {
    chart: {
        type: 'column'
    },
    title: {
        text: 'similarity'
    },
    xAxis: {
        type: 'category'
    },
    yAxis: {
        title: {
            text: 'similarity'
        }

    },
    legend: {
        enabled: false
    },
    plotOptions: {
        series: {
            borderWidth: 0,
            dataLabels: {
                enabled: true,
                format: '{point.y:.4f}%'
            }
        }
    },

    tooltip: {
        headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
        pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y:.2f}%</b> of total<br/>'
    },

    series: [
        {
            name: "similarity",
            colorByPoint: true,
            data: [
                {
                    name: "BBH",
                    y: a,
                    drilldown: "Chrome"
                },
                {
                    name: "CG",
                    y: b,
                    drilldown: "Firefox"
                },
                {
                    name: "상수",
                    y: 7.23,
                    drilldown: "Internet Explorer"
                },
                {
                    name: "PE",
                    y: 10.58,
                    drilldown: "Safari"
                },
            ]
        }
    ],
});
        i++;
}
    i = 0;
}
        </script>

    </div>
    {% else %}
    <h1>There is not result!</h1>
    {% endif %}
</div>

{% endblock section %}