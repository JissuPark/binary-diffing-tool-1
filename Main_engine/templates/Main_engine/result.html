{% extends "Main_engine/layout.html" %}

{% block title %} 결과 페이지 {% endblock %}

{% block head %}
{% load static %} <!-- static files are loaded -->
<script>
    $(function () {
        $().timelinr({
            arrowKeys: 'true'
        })
    });
</script>
<style>
    .container_a {
        margin-top: 10px;
    }

    .progress-bar-vertical {
        width: 20px;
        min-height: 100px;
        display: flex;
        align-items: flex-end;
        margin-right: 20px;
        float: left;
    }

    .progress-bar-vertical .progress-bar {
        width: 100%;
        height: 0;
        -webkit-transition: height 0.6s ease;
        -o-transition: height 0.6s ease;
        transition: height 0.6s ease;
    }

    button#select-oper {
        background-color: lightgray;
        border-radius: 5px;
        font-weight: bold;
        font-size: large;
        width: 20%;
        margin-left: 20px;
        margin-right: 20px;
        text-align: center;
    }

    button#select-oper:hover {
        background-color: #d8d8d8;
        color: red;
        border: white;
    }

    p.file_text {
        width: 20%;
        margin: 6px;
        font-size: large;
        font-weight: bold;
        text-align: center;
    }
</style>

{% endblock head %}

{% block section %}

{% load static %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom mt-5">
    <h3>Result</h3>
    <div class="btn-toolbar mb-2 mb-md-0">
        <div class="btn-group mr-2">
            <button type="button" class="btn btn-sm btn-outline-secondary">high</button>
            <button type="button" class="btn btn-sm btn-outline-secondary">all</button>
        </div>
    </div>
</div>

{#휴리스틱 스코어부분 #}
<!--원래 있던 차트 부분-->
<br>

<div style="display:inline-flex; width:100%;">
    <p class="file_text">select base file : </p>
    <select id="select_base" class="selectpicker" data-live-search="true" data-width="20%" data-size="5"
            title="Choose base"></select>
    <p class="file_text">select target file : </p>
    <select id="select_target" class="selectpicker" data-actions-box="true" data-width="20%" data-size="5" multiple title="Choose targets"></select>
    <button id="select-oper">select</button>
</div>
<hr class="my-hr3"><h5 id="heuristic" class="mt-2 mb-3" style="font-weight: bold;">Heuristic Score</h5>
<hr class="my-hr3">

<!--원래 있던 차트 부분-->
<div class="card-deck ml-3 mr-3 mt-4" id="test">

</div>

<br>
<br>

<hr class="my-hr3"><h5 id="scoretable" class="mt-2 mb-3" style="font-weight: bold;">Detail</h5>
<hr class="my-hr3">
<div class="container-fluid">
    <div class="table-responsive container-fluid">
        {% csrf_token %}
        {% if result %}
        <div id="result_json">
            <table id="result_table" class="table table-corderless" style="text-align: center;">
                <thead>
                <tr>
                    <th rowspan="2" align=center>File Name</th>
                    <!--                <th rowspan="2">Timestamp</th>-->
                    <th colspan="2">Algorithm</th>
                    <th colspan="6">PE META data</th>
                </tr>
                <tr>
                    <th>BBH</th>
                    <th>Constant</th>
                    <th>Section data</th>
                    <th>certification</th>
                    <th>PDB</th>
                    <th>imp-hash</th>
                    <th>Rich-xorkey</th>
                </tr>
                </thead>
            </table>
        </div>
    </div>
</div>
<script>
    // var dictionary = "{{ json_data }}";
    /* 엔진에서 받아온 값 */
    var result = "{{result}}";
    /* JSON.parse()에서 따옴표, nan 기타 등등 있으면 오류남 */
    var text_res = result.replace(/&#39;/gi, '"').replace(/\t/gi, "\\t").replace(/\r/gi, "\\r").replace(/\n/gi, "\\n").replace(/nan/gi, '"nan"');
    /* 결과값 파싱해서 테이블 추가하는 부분 */
    /* 테이블 불러오기 */
    var res_table = document.getElementById("result_table");
    /* 결과 데이터 파싱 */

    var json_res = JSON.parse(text_res);
    /* 파일에 맞게 동적으로 dropdown에 option 추가해주는 부분 */
    var pickerclass = document.getElementsByClassName("selectpicker");
    for (var picker = 0; picker < pickerclass.length; picker++) {
        for (var standard in json_res) {
            var option = document.createElement("option");
            option.value = standard;
            option.text = standard;
            pickerclass.item(picker).appendChild(option);
        }
    }
    /* 버튼 클릭하면 데이터 변하게 하는 함수 */
    $("#select-oper").click(function () {
        $all_select();
    });

    /* 기준이 바뀌면 대상에 disable 거는 함수 */
    $("#select_base").on("changed.bs.select", function () {
        var selected = $("#select_base").children("option:selected").text();        // 기준 파일명을 가져옴
        $("#select_target option").prop('disabled', false);                         // 전체 초기화
        $('#select_target').find('[value="' + selected + '"]').prop('selected', false);// 체크도 해제
        $("#select_target").find('[value="' + selected + '"]').prop('disabled', true);// 기준과 같은 옵션 disable
        $("#select_target").selectpicker('refresh');                                // 새로고침
    });

    /* 기준이 변하면 테이블이 변경될 수 있도록 */
    $all_select = function () {
        var targets = $('#select_target').val();
        /* 기준이 변할때마다 테이블을 지우고 새로 시작 */
        for (var row = res_table.rows.length - 1; row > 1; row--) {
            res_table.deleteRow(row);
            $("#test").empty();
        }

        for (var standard in json_res) {
            var sel = document.getElementById("select_file");
            var selected = $("#select_base").children("option:selected").text();
            if (standard == selected) {
                // document.write(sel.selectedIndex + " is " + "<br>");
                var index = 0;
                /* 대상이 변할때마다 */
                for (var target in json_res[standard]) {
                    for (var t in targets) {
                        // 선택된 대상에 대해서만 보여줌
                        if (target == targets[t]) {

                            /* 하단에 행 추가 */
                            var new_row = res_table.insertRow(res_table.rows.length);
                            /* 행에 열 추가 */
                            var filename = new_row.insertCell(0);
                            var bbh = new_row.insertCell(1);
                            var constvalue = new_row.insertCell(2);
                            var section = new_row.insertCell(3);
                            var cert = new_row.insertCell(4);
                            var pdb = new_row.insertCell(5);
                            var imph = new_row.insertCell(6);
                            var xor = new_row.insertCell(7);
                            /* 열에 데이터 입력 */
                            filename.innerHTML = json_res[standard][target][0];
                            bbh.innerHTML = json_res[standard][target][2];
                            constvalue.innerHTML = json_res[standard][target][3];
                            section.innerHTML = json_res[standard][target][4];
                            cert.innerHTML = json_res[standard][target][5];
                            pdb.innerHTML = json_res[standard][target][6];
                            imph.innerHTML = json_res[standard][target][7];
                            xor.innerHTML = json_res[standard][target][8];

                            var container = document.createElement('div');
                            container.className = "container-a";
                            container.id = "outer" + index;
                            document.getElementById('test').appendChild(container);
                            var vertical_bar = document.createElement('div');
                            vertical_bar.className = "progress progress-bar-vertical";
                            vertical_bar.id = "inner" + index;
                            document.getElementById('outer' + index).appendChild(vertical_bar);
                            var progress_bar_1 = document.createElement('div');
                            progress_bar_1.className = "progress-bar";
                            progress_bar_1.setAttribute("style", "height: 30%");
                            document.getElementById('inner' + index).appendChild(progress_bar_1);
                            var progress_bar_2 = document.createElement('div');
                            progress_bar_2.className = "progress-bar";
                            progress_bar_2.setAttribute("style", "height: 30%");
                            document.getElementById('inner' + index).appendChild(progress_bar_2);
                            var progress_bar_3 = document.createElement('div');
                            progress_bar_3.className = "progress-bar";
                            progress_bar_3.setAttribute("style", "height: 30%");
                            document.getElementById('inner' + index).appendChild(progress_bar_3);
                            //그래프 맹드는 부분
                            // var card = document.createElement("div");
                            // card.className = 'card';
                            // card.id = "card" + index;
                            // document.getElementById("test").appendChild(card);
                            // var chart = document.createElement("div");
                            // chart.id = "mychart" + index;
                            // document.getElementById("card" + index).appendChild(chart);
                            // var a = json_res[standard][target][2];
                            // var b = json_res[standard][target][3];
                            // var c = json_res[standard][target][0];
                            // // var card
                            // Highcharts.chart("mychart" + index, {
                            //     chart: {
                            //         type: 'column'
                            //     },
                            //     title: {
                            //         text: 'similarity'
                            //     },
                            //     xAxis: {
                            //         type: 'category'
                            //     },
                            //     yAxis: {
                            //         title: {
                            //             text: 'similarity'
                            //         }
                            //
                            //     },
                            //     legend: {
                            //         enabled: false
                            //     },
                            //     plotOptions: {
                            //         series: {
                            //             borderWidth: 0,
                            //             dataLabels: {
                            //                 enabled: true,
                            //                 format: '{point.y:.4f}%'
                            //             }
                            //         }
                            //     },
                            //
                            //     tooltip: {
                            //         headerFormat: '<span style="font-size:11px">{series.name}</span><br>',
                            //         pointFormat: '<span style="color:{point.color}">{point.name}</span>: <b>{point.y:.2f}%</b> of total<br/>'
                            //     },
                            //
                            //     series: [
                            //         {
                            //             name: "similarity",
                            //             colorByPoint: true,
                            //             data: [
                            //                 {
                            //                     name: "BBH",
                            //                     y: a,
                            //                     drilldown: "Chrome"
                            //                 },
                            //                 {
                            //                     name: "CG",
                            //                     y: b,
                            //                     drilldown: "Firefox"
                            //                 },
                            //                 {
                            //                     name: "상수",
                            //                     y: 7.23,
                            //                     drilldown: "Internet Explorer"
                            //                 },
                            //                 {
                            //                     name: "PE",
                            //                     y: 10.58,
                            //                     drilldown: "Safari"
                            //                 },
                            //             ]
                            //         }
                            //     ]
                            // });
                            index++;
                        }

                    }
                }
            }
        }
    };
    // 페이지가 처음 뜰 때 기준은 처음으로 대상은 전부 선택해서 보여주도록
    var first_base = $("#select_base").find('option:first');
    first_base.attr('selected', 'selected');
    $('#select_target option').prop('selected', true);
    $('#select_target').find('[value=' + first_base.text() + ']').prop('selected', false);
    $('#select_target').find('[value=' + first_base.text() + ']').prop('disabled', true);

    $all_select();
</script>

</div>
{% else %}
<h1>There is not result!</h1>
{% endif %}
</div>

{% endblock section %}